%% Evaluación 11.2 (PLANEACION DE TRAYECTORIAS) ---- LANDMARKS
%José Diego Tomé Guardado A01733345

%% EXAMPLE: Differential drive vehicle following waypoints using the 
% Pure Pursuit algorithm
%
% Copyright 2018-2019 The MathWorks, Inc.

%% Define Vehicle
R = 0.1;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.05;               % Sample time [s]
tVec = 0:sampleTime:400;         % Time array

%CAMBIAR CONFORME A LAS ESPECIFICACIONES DE CADA TRAYECTORIA O DIBUJO
initPose = [2.9028608777496;0.1897059908332;0];             % Initial pose (x y theta)
pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints
% ----- Ejercicio Trayectoria: Rostro -------------
waypoints = [2.9028608777496,0.1897059908332; 2.6364459329991,0.2563097270208; 2.3182280823249,0.4043180296599;
    2.1628193645538,0.5227246717713; 1.7927986079559,0.8927454283692; 1.6891927961084,1.0555545612723;
    1.6077882296569,1.1813616185156; 1.5263836632054,1.3367703362867; 1.4301782664899,1.4773782237939;
    1.3635745303023,1.6549881869609; 1.3191720395105,1.8696002257877; 1.2969707941146,2.0990130948784;
    1.2525683033229,2.3728284547609; 1.230367057927,2.6836458903031; 1.0991497212291,2.81836616; 1.0373272107413,3.06565620;
    1.0424790866152,3.251123735821; 1.0424790866152,3.3747687567966; 1.0888459694811,3.5396287847642; 1.230367057927,3.653100272589;
    1.2081658125311,3.408886573235; 1.2155662276631,3.09806913; 1.230367057927,2.6836458903031; 1.0991497212291,2.8183661;
    1.0373272107413,3.065656204357; 1.0424790866152,3.251123735821; 1.0888459694811,3.5396287847642; 1.2081658125311,3.408886573235;
    
    1.6213406161376,3.43980417; 1.727509870405,3.4801484919903; 1.8336791246723,3.5013823428438; 1.9313548385983,3.5162460384412;
    2.1182127261088,3.5396032743801; 2.2413690610589,3.5204928086119; 2.3263044644728,3.484395262161; 2.4303503336547,3.4419275604541;
    2.4876817309591,3.363362312296; 2.419733408228,3.329388; 2.3029472285339,3.310277685162; 2.2265053654615,3.3017841448212;
    2.1330764217062,3.2911672193945;2.0056733165854,3.2954139895652; 1.886763751806,3.3272647658454; 1.8,3.4;
    1.8336791246723,3.501382342; 1.9313548385983,3.5162460384412; 1.9695757701345,3.4334340201127; 2.0247837823535,3.3569921; 2.1330764217062,3.2911672193945;
    2.2243819803761,3.3506220017842; 2.2647262969977,3.4355574051981; 2.3263044644728,3.484395262161; 
    
    2.4032544800145,3.829751819205; 2.2974835093389,3.85964361; 2.1940119075911,3.8573442463377;
    2.1273302086869,3.8573442463377; 2.0399541894332,3.8573442463377; 1.9663743837459,3.8665417;
    1.9111895294804,3.8665417220487; 1.8146160345157,3.8918347802537; 1.7318387531175,3.9171278384587;
    1.6030740931646,3.90103225; 1.5616854524655,3.880337935615; 1.4812075399949,3.8573442463377;
    1.3756869703868,3.822672457459; 1.3409806084558,3.9094383622867; 1.421423947874,3.965414585941;
    1.5042012292722,4.0366950227006; 1.6444627338637,4.0550899741225; 1.727240015262,4.0527906051948;
    1.8100172966603,4.0412937605561; 1.8766989955644,4.0228988091343; 1.9939668108786,4.0297969159175;
    2.1204321019038,4.00910259556; 2.2,4; 2.3595664703876,3.9930070130738; 2.4124519557254,3.949319003446; 
    2.5090254506901,3.8642423531209; 2.4032544800145,3.829751819205; 2.2974835093389,3.85964361; 2.1940119075911,3.8573442463377;
    2.1273302086869,3.8573442463377; 2.0399541894332,3.8573442463377; 1.9663743837459,3.8665417;
    1.9111895294804,3.8665417220487; 1.8146160345157,3.8918347802537; 1.7318387531175,3.9171278384587;
    1.6030740931646,3.90103225; 1.5616854524655,3.880337935615; 1.4812075399949,3.8573442463377;
    1.3756869703868,3.822672457459;
    
    1.230367057927,3.6531002725897; 1.0888459694811,3.5396287847642; 0.9188340656396,3.7147925644797; 0.8879228103957,3.9002600959431;
    0.9394415691355,4.4257514350896; 0.9703528243795,4.631826470049; 0.9033784380177,4.8275977532605; 0.9033784380177,4.8275977532605;
    0.8930746862697,5.0697359193378; 1.0115678313713,5.2655072025492; 1.142541293979,5.4811721073601; 1.3151044544884,5.6809820826868;
    1.4740442075892,5.8490041073933; 1.5376201088295,6.0578963543258; 1.6965598619303,6.2213772432294; 1.9463223310887,6.3031176876813;
    2.0961798125837,6.3666935889216; 2.3284632255237,6.5997651912087; 2.5626829926611,6.6342092746113; 2.7762363097571,6.6824309913749;
    3.0586777936581,6.6410980912918; 3.2515646607125,6.6204316412503; 3.4582291611279,6.585987557; 3.6786712949044,6.5446546577646;
    3.8164476285146,6.468877674279; 3.9404463287639,6.4137671408349; 4.1057779290962,6.2828796239051; 4.2986647961506,6.13821; 4.5,6;
    4.6017727300932,5.8971058897963; 4.746437880384,5.690441389380; 4.7808819637865,5.5457762390901; 4.7946595971476,5.3528893720358;
    4.8084372305086,5.2013354050645; 4.8704365806332,4.994670904649; 4.9255471140773,4.7811175875531;4.9462135641189,4.6157859872; 5,4.5;
    4.987546464202,4.3540109533613; 4.9944352808825,4.1749017196679; 5,4; 4.9255471140773,3.69957336; 4.9117694807163,3.5204641350191; 4.8911030306748,3.4033542514;
    4.9599911974799,3.2242450177; 4.9599911974799,3.086468684146; 4.9180179048747,2.8798628092511;
    4.8608196044854,2.6686690847367; 4.6619992113252,2.5178037823777; 4.6872117123331,2.6396642039; 4.6956158793357,2.8035454604668;
    4.7082221298396,2.9170017150022; 4.7048920476659,2.9838709336251; 4.7048920476659,3.3224068228; 4.7105343124859,3.6665849768517;
    
    4.6823229883857,3.8189261269932; 4.5865972594652,3.8962977735646; 4.5502228081451,3.9756602128084; 4.4642468322976,4.0484091154486;
    4.3716573198465,4.0880903350706; 4.2559204292825,4.1343; 4.169944453435,4.154225; 4.0938887824929,4.15753246; 3.9880721968345,4.1476121645035;
    3.862415001365,4.117851; 3.7499848791029,4.08478356; 3.6309412202371,4.0451023471468; 3.4953637198622,4.01203466; 3.5284314028805,3.92936545;
    3.6243276836335,3.8797639320554; 3.7235307326883,3.88307070; 3.8524946964595,3.92936; 3.9682315870235,3.93597899; 4.0707414043802,3.9425925297;
    4.2129324413587,3.92275191; 4.3253625636209,3.9029113101682; 4.3253625636209,3.9029113101682; 4.4807806738068,3.8400827124335;
    4.6031311009744,3.7574135048878; 4.7105343124859,3.6665849768517; 4.7048920476659,3.5029592970701;
    
    
    4.265840734188,3.4961788090435; 4.1765579900386,3.539166796967; 4.0575143311728,3.5689277116837; 
    4,3.6; 3.8921759160815,3.608608931; 3.7797457938193,3.62514277281; 3.710303659481,3.62514277281; 
    3.6177141470298,3.6251427728147; 3.5251246345786,3.5557006384764; 3.4523757319384,3.4201231; 3.5581923175969,3.38044191847;
    3.6441682934444,3.3606013086685; 3.7731322572157,3.3440674671594; 3.8987894526851,3.3440674671594; 4.0608210994747,3.360601308668;
    4.2,3.4; 4.265840734188,3.4961788090435; 4.1765579900386,3.539166796967; 4.0575143311728,3.5689277116837; 
    4,3.6; 3.8921759160815,3.608608931; 3.7797457938193,3.62514277281; 3.710303659481,3.62514277281; 
    3.670622439859,3.542473565269; 3.7003833545755,3.4631111260252; 3.7632119523102,3.4068960648941; 3.8987894526851,3.3440674671594; 3.9682315870235,3.466417;
    3.9616180504198,3.5590074067782; 3.8921759160815,3.6086089; 3.7797457938193,3.6251427728147; 3.710303659481,3.62514277281; 
    3.670622439859,3.542473565269; 3.7003833545755,3.4631111260252; 3.7632119523102,3.4068960648941; 3.8987894526851,3.3440674671594; 3.9682315870235,3.466417;
    3.9616180504198,3.5590074067782; 3.8921759160815,3.6086089; 4.0608210994747,3.3606013086685; 4.2,3.4; 4.265840734188,3.4961788090435;
    
    
    4.7048920476659,3.502959297; 4.7048920476659,3.322406822; 4.716176577306,3.113643024; 4.7082221298396,2.9170017150022; 4.6872117123331,2.6396642;
    4.6619992113252,2.437964195; 4.6535950443226,2.278285022803; 4.6409887938186,2.1396162672597; 4.6,2; 4.565351290795,1.85807667267;
    4.510724205278,1.681589165; 4.456097119761,1.54712249; 4.4224804517505,1.44207040; 4.3720554497348,1.33701831; 4.3048221137138,1.2193599804727;
    4.2081741931836,1.047074; 4.1493450241653,0.93361830; 4.0484950201338,0.7865453798377; 3.9392408490998,0.6562807912971;
    3.9088033738035,0.6144588929193; 3.8503985672739,0.535914497; 3.7940077195901,0.4573701029431; 3.6812260242226,0.3808396668;
    3.6147653823096,0.350630284; 3.5362209873215,0.302295271; 3.4113555388788,0.2539602595124; 3.2562807077485,0.22375087;
    3.0850942058513,0.2076392060578; 2.9028608777496,0.1897059908332
    
    2.6364459329991,0.25630972; 2.5297757233593,0.461735934; 2.4233436837771,0.5157491802897;
    2.2880922069168,0.620460001084; 2.1528407300564,0.716444920147; 2.0001374497303,0.8647852496067; 
    1.9172413832675,0.9956737756006; 1.8387082676711,1.1571029576597; 1.7732640046742,1.3708875501164;
    1.7078197416772,1.59776099517; 1.5856571174163,1.7286495211; 1.4793733549396,1.9252240644707; 1.3813212128262,2.0500176998878;
    1.2525683033229,2.372828; 1.230367057927,2.6836458903031; 1.2155662276631,3.098069137; 1.2081658125311,3.408886573235; 1.2155662276631,3.9787185383958;
    1.2747695487188,4.5263492581607; 1.5,5; 1.5508660132551,5.195638743086; 1.7032071633966,5.3536221580482; 2.1320192897208,5.6583044583311; 
    2.2674336454021,5.6921580472515; 2.6398231235257,5.6752312527913; 2.9219363645285,5.6583044583311; 3.1532692221507,5.6865157824314;
    3.4353824631535,5.7147271065317; 3.6272194670354,5.7372961658119; 3.790845146817,5.7260116361718; 3.9939666803389,5.6018818101306;
    4.1463078304804,5.5228901026498; 4.2647953917016,5.3761912173284; 4.3663561584626,5.2633459209273; 4.4679169252236,5.122289300425; 4.5920467512648,4.86838738352; 4.6428271346453,4.7104039685619; 
    4.6259003401851,4.5919164073407; 4.6259003401851,4.4565020516594; 4.6597539291054,4.3210876959781; 
    4.6653961939255,4.1292506920962; 4.6879652532057,3.9261291585742; 4.7105343124859,3.6665849768517;
    4.6823229883857,3.8189261269932; 4.7048920476659,3.5029592970701; 4.7048920476659,3.3224068228284; 
    4.7048920476659,2.9838709336251; 4.7082221298396,2.9170017150022; 4.6956158793357,2.8035454604668;
    4.6872117123331,2.6396642039157; 4.6619992113252,2.5178037823777;
    
    4.5655525592104,2.1736705095456; 4.4695676401482,2.0209672292194; 4.4,1.8; 4.137983374297,1.370887550116;
    4.0899909147659,1.135288203327; 4.0027318974367,0.9345924634701; 3.8980210766416,0.7688003305445; 3.7714955015141,0.6335488536842;
    3.6449699263867,0.5157491802897; 3.4852539506288,0.5578491292839; 3.329776724298,0.6567891824035;
    3.1940875085911,0.6850577690091; 3.0894937381503,0.6850577690091; 2.9679388157462,0.6991920623119;
    2.9679388157462,0.6991920623119; 2.8294227413788,0.693538; 2.7191752536169,0.645481;
    2.6202352004973,0.54654169; 2.5297757233593,0.4617359348; 2.7191752536169,0.645481747;
    
    2.9679388157462,0.699192062; 2.9917533651124,1.167548420; 3.0838629531583,1.1586345897662; 3.1611161560355,1.1289218194288;
    3.4,1.2; 3.553324724489,1.2745143; 3.4998417378817,1.2507441; 3.6305779273662,1.35771;
    3.5949226029613,1.4290207998364; 3.5176694000841, 1.5211303;3.3839619335659,1.5538144;
    3.2829385144188,1.580555; 3.2,1.6; 3.0838629531583,1.54787; 2.962040594775,1.53598677305;
    2.8521033445267,1.5805559285571; 2.8521033445267,1.5805559285; 2.7421660942784,1.5835272;
    2.6054873507264,1.54787; 2.5014926545456,1.52707; 2.5401192559842,1.244801623744; 2.5817171344565,1.434963;
    2.7154246009747,1.3874229213641; 2.8283331282568,1.3577101510267; 2.97392570291,1.3636527050942;
    3.1195182775632,1.375; 3.2591682981489,1.4230782; 3.3928757646671,1.4349633539039;3.5206406771178,1.43793463;
    3.5949226029613,1.42902; 3.5176694000841,1.52113038788; 3.3839619335659,1.5538144352534;
    3.2829385144188,1.58055592; 3.2,1.6; 3.0838629531583,1.547871; 3.2,1.6; 3.2829385144188,1.5805559; 3.3839619335659,1.55381;
    3.5176694000841,1.521130; 3.5949226029613,1.4290; 3.6305779273662,1.35771; 3.553324724489,1.27451;
    3.4998417378817,1.25074; 3.4,1.2; 3.2740246833176,1.12892; 3.1611161560355,1.1289; 3.0838629531583,1.1586; 2.9917533651124,1.16754;
    2.8699310067291,1.13783565; 2.724338432076,1.149720; 2.6322288440301,1.1883; 2.5401192559842,1.244801; 2.4539522220058,1.30719844145;
    2.3856128502298,1.3577101510; 2.2935032621839,1.42604952; 2.3856128502298,1.50627; 2.5014926545456,1.527072; 2.6054873507264,1.5478718;
    2.7421660942784,1.5835; 2.8521033445267,1.58055592; 2.962040594775,1.535986773051; 3.0838629531583,1.54787;
    
    2.962040594775,1.9965; 3.0779203990908,2.05893; 3.1819150952717,2.133213456;
    3.3037374536549,2.1956102; 3.4879566297467,2.1896677204735; 3.553324724489,2.3055475247893;
    3.5236119541516,2.48085; 3.4938991838142,2.5343358563871; 3.4641864134768,2.5907901;
    3.4315023661057,2.66210; 3.404760872802,2.733; 3.4,2.8
    
    3.3750481024647,2.887917; 2.6411426751313,2.8017; 2.6084586277602,2.62941; 2.5163490397143,2.531364;
    2.3885841272635,2.359030; 2.3796702961623,2.308518; 2.382641573196,2.23126559; 2.4301820057359,2.195610;
    2.4985213775118,2.18075; 2.6,2.2; 2.6886831076711,2.17778; 2.7629650335146,2.1302421797987; 
    2.8788448378304,2.032190; 2.962040594775,1.9965]
 

% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
%muy largo no sabremos a que way point va a ir
controller.LookaheadDistance = 0.15; %muy corto no vera el waypoint
controller.DesiredLinearVelocity = 0.15;
controller.MaxAngularVelocity = 800;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef)
 
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints)
    waitfor(r);
    
end
